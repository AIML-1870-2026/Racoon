<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/return-of-ganon" rel="stylesheet">
    <style>
        :root {
            --felt-green: #1a5f2a;
            --felt-dark: #0d3d16;
            --gold: #d4af37;
            --gold-light: #f4cf67;
            --card-white: #fff;
            --win-green: #4caf50;
            --lose-red: #f44336;
            --push-yellow: #ffc107;
            --text-light: #fff;
            --text-dark: #1a1a1a;
            --chip-red: #c62828;
            --chip-blue: #1565c0;
            --chip-green: #2e7d32;
            --chip-black: #212121;
            --overlay-bg: rgba(0,0,0,0.85);
        }

        .theme-dark {
            --felt-green: #1a1a2e;
            --felt-dark: #0f0f1a;
            --gold: #00d4ff;
            --gold-light: #7c4dff;
            --card-white: #2a2a3e;
            --text-light: #e0e0e0;
        }

        .theme-retro {
            --felt-green: #2d1b69;
            --felt-dark: #1a0f3c;
            --gold: #ff6b6b;
            --gold-light: #ffd93d;
            --card-white: #fffef0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        button { font-family: inherit; }

        body {
            font-family: 'Times New Roman', 'Georgia', serif;
            background: linear-gradient(135deg, var(--felt-dark) 0%, var(--felt-green) 50%, var(--felt-dark) 100%);
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
        }

        .theme-retro, .theme-retro body, .theme-retro * {
            font-family: 'Return of Ganon', cursive;
            image-rendering: pixelated;
        }

        .game-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .table-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-box {
            position: fixed;
            bottom: 55px;
            left: 30px;
            background: rgba(0,0,0,0.5);
            padding: 22.5px 30px;
            border-radius: 14px;
            z-index: 50;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin: 8px 0;
        }

        .info-label {
            font-size: 1rem;
            opacity: 0.8;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold);
        }

        .info-value.negative { color: var(--lose-red); }

        .top-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--gold);
            color: var(--gold);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover { background: var(--gold); color: var(--felt-dark); }

        .icon-btn svg {
            display: block;
        }

        .mode-indicator {
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: none;
        }

        .mode-indicator.active { display: block; }

        .mode-buttons {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--text-light);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--gold);
        }

        .mode-btn.active {
            background: var(--gold);
            color: var(--text-dark);
            border-color: var(--gold);
        }

        .dealer-area, .player-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
        }

        .area-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .cards-container {
            display: flex;
            gap: -30px;
            min-height: 140px;
            align-items: center;
            perspective: 1000px;
        }

        .card {
            width: 90px;
            height: 130px;
            background: var(--card-white);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-family: 'Times New Roman', 'Georgia', serif;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            transition: transform 0.3s;
            margin-left: -30px;
            color: var(--text-dark);
        }

        .card:first-child { margin-left: 0; }

        .card.red { color: #c41e3a; }
        .card.black { color: #000000; }

        .card .center-suit {
            font-size: 2.5rem;
            line-height: 1;
        }

        .card-back {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
        }

        .card-back::after {
            content: '';
            position: absolute;
            inset: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .card .suit-top, .card .suit-bottom {
            position: absolute;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.1;
        }

        .card .suit-top { top: 4px; left: 6px; }
        .card .suit-bottom { bottom: 4px; right: 6px; transform: rotate(180deg); }

        .card .rank {
            font-size: 0.85rem;
            font-weight: bold;
        }

        .card .pip {
            font-size: 0.7rem;
        }

        .card.dealing {
            animation: dealCard 0.4s ease-out;
        }

        @keyframes dealCard {
            from { transform: translateY(-200px) rotate(-20deg); opacity: 0; }
            to { transform: translateY(0) rotate(0); opacity: 1; }
        }

        .card.flip {
            animation: flipCard 0.5s ease-in-out;
        }

        @keyframes flipCard {
            0% { transform: rotateY(0); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0); }
        }

        .hand-total {
            margin-top: 15px;
            font-size: 1.3rem;
            background: rgba(0,0,0,0.5);
            padding: 8px 20px;
            border-radius: 20px;
            min-width: 60px;
            text-align: center;
        }

        .hand-total.bust { background: var(--lose-red); }
        .hand-total.blackjack { background: var(--gold); color: var(--text-dark); }

        .betting-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            margin: 20px 0;
        }

        .bet-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .bet-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            background: rgba(0,0,0,0.3);
            color: var(--gold);
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        .bet-btn:hover:not(:disabled) { background: var(--gold); color: var(--felt-dark); }
        .bet-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #betDown::after { content: 'âˆ’'; }
        #betUp::after { content: '+'; }

        .bet-amount {
            font-size: 2rem;
            font-weight: bold;
            color: var(--gold);
            width: 6ch;
            text-align: center;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .bet-amount:focus {
            border-color: var(--gold);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .action-btn.primary {
            background: var(--gold);
            color: var(--text-dark);
        }

        .action-btn.primary:hover:not(:disabled) {
            background: var(--gold-light);
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .action-btn.secondary:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .result-banner {
            position: fixed;
            top: 50%;
            left: calc(50% - 140px);
            transform: translate(-50%, -50%);
            padding: 30px 60px;
            border-radius: 15px;
            font-size: 2rem;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            z-index: 100;
            animation: popIn 0.3s ease-out;
            display: none;
        }

        .result-banner.show { display: block; }
        .result-banner.win { background: var(--win-green); }
        .result-banner.lose { background: var(--lose-red); }
        .result-banner.push { background: var(--push-yellow); color: var(--text-dark); }
        .result-banner.blackjack { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%); color: var(--text-dark); }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @media (max-width: 900px) {
            .result-banner {
                left: 50%;
            }
        }

        .payout-info {
            font-size: 1rem;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* Stats Panel */
        .stats-panel {
            width: 280px;
            background: rgba(0,0,0,0.4);
            padding: 15px 18px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.1);
        }

        .stats-panel h2 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gold);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.95rem;
        }

        .stat-label { opacity: 0.8; }
        .stat-value { font-weight: bold; }
        .stat-value.positive { color: var(--win-green); }
        .stat-value.negative { color: var(--lose-red); }

        .sub-stat {
            font-size: 0.85rem;
            opacity: 0.6;
            margin-left: 10px;
        }

        .streak-display {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            text-align: center;
            font-size: 0.95rem;
        }

        .streak-display.win-streak { border-left: 3px solid var(--win-green); }
        .streak-display.lose-streak { border-left: 3px solid var(--lose-red); }

        .reset-stats-btn {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            width: 100%;
        }

        .reset-stats-btn:hover { background: rgba(255,255,255,0.2); }

        /* Keyboard Shortcuts */
        .shortcuts-section {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .shortcuts-section h3 {
            font-size: 0.95rem;
            margin-bottom: 8px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.9rem;
        }

        .shortcut-key {
            background: rgba(255,255,255,0.15);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            min-width: 28px;
            text-align: center;
        }

        .shortcut-desc {
            opacity: 0.7;
        }

        /* Mobile Stats Toggle */
        .stats-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }

        /* Fireworks Canvas */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 90;
        }

        /* Overlays */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--overlay-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .overlay.show { display: flex; }

        .modal {
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid var(--gold);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .modal::-webkit-scrollbar {
            display: none;
        }

        .modal h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--gold);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--gold);
            color: var(--gold);
            font-size: 1.2rem;
            font-weight: bold;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--gold);
            color: var(--felt-dark);
        }

        .modal p { margin-bottom: 15px; line-height: 1.6; }

        .modal-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .modal-section h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--gold);
        }

        .modal-section ul {
            margin-left: 20px;
        }

        .modal-section li {
            margin: 8px 0;
        }

        .strategy-box {
            background: linear-gradient(135deg, var(--win-green) 0%, #2e7d32 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .strategy-box h4 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .strategy-box p {
            font-style: italic;
            margin-bottom: 0;
        }

        .strategy-box.disabled {
            background: rgba(255,255,255,0.1);
            opacity: 0.6;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin: 5px;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: var(--gold);
            color: var(--text-dark);
        }

        .modal-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }

        /* Tutorial */
        .tutorial-overlay {
            background: rgba(0,0,0,0.9);
        }

        .tutorial-content {
            max-width: 600px;
        }

        .tutorial-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
        }

        .tutorial-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }

        .tutorial-dot.active { background: var(--gold); }
        .tutorial-dot.complete { background: var(--win-green); }

        .tutorial-skip {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--text-light);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .quiz-option {
            padding: 15px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quiz-option:hover { border-color: var(--gold); }
        .quiz-option.correct { border-color: var(--win-green); background: rgba(76,175,80,0.2); }
        .quiz-option.incorrect { border-color: var(--lose-red); background: rgba(244,67,54,0.2); }

        /* Debt Pause */
        .debt-overlay {
            background: rgba(20,0,0,1);
        }

        .debt-modal {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: transparent;
        }

        .debt-timer {
            font-size: 6rem;
            font-weight: bold;
            color: var(--lose-red);
            margin: 50px 0;
            font-family: monospace;
        }

        .debt-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .debt-buttons.hidden { display: none; }

        .debt-question {
            margin-top: 20px;
        }

        .debt-question h3 {
            color: var(--gold);
            font-size: 1.5rem;
        }

        .debt-question.hidden { display: none; }

        /* Settings Panel */
        .settings-section {
            margin: 20px 0;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: var(--gold);
        }

        .theme-options {
            display: flex;
            gap: 10px;
        }

        .theme-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-btn.active {
            border-color: var(--gold);
            background: rgba(212,175,55,0.2);
        }

        .toggle-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.2);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-switch.active { background: var(--win-green); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.2s;
        }

        .toggle-switch.active::after { left: 26px; }

        .volume-slider {
            width: 100%;
            margin-top: 10px;
        }

        /* Card Counter HUD */
        .counter-hud {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 15px;
            width: 250px;
            display: none;
            z-index: 50;
        }

        .counter-hud.show { display: block; }

        .counter-hud h3 {
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .counter-hud .disclaimer {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-bottom: 15px;
            padding: 5px;
            background: rgba(255,0,0,0.2);
            border-radius: 4px;
        }

        .count-display {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .count-value { font-weight: bold; }
        .count-value.positive { color: var(--win-green); }
        .count-value.negative { color: var(--lose-red); }

        .card-history {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .history-card {
            width: 30px;
            height: 40px;
            background: white;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-dark);
        }

        .history-card .hi-lo {
            font-size: 0.6rem;
            padding: 1px 3px;
            border-radius: 2px;
            margin-top: 2px;
        }

        .hi-lo.plus { background: var(--win-green); color: white; }
        .hi-lo.minus { background: var(--lose-red); color: white; }
        .hi-lo.zero { background: #888; color: white; }

        /* Keyboard hints */
        .key-hints-container {
            margin-top: 20px;
        }

        .key-hint-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .key-badge {
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .game-container { flex-direction: column; }

            .stats-panel {
                position: fixed;
                top: 0;
                right: -300px;
                height: 100vh;
                width: 280px;
                z-index: 150;
                transition: right 0.3s;
            }

            .stats-panel.open { right: 0; }

            .stats-toggle { display: block; }

            .card {
                width: 70px;
                height: 100px;
                font-size: 1.4rem;
            }

            .action-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }

            .bet-amount { font-size: 1.5rem; }
        }

        @media (max-width: 500px) {
            .top-bar { flex-direction: column; gap: 10px; }

            .card {
                width: 55px;
                height: 80px;
                font-size: 1.1rem;
                margin-left: -20px;
            }

            .action-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

        }

        /* First-time prompt */
        .welcome-modal {
            text-align: center;
        }

        .welcome-modal h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            opacity: 0.7;
            margin-bottom: 30px;
        }

        .welcome-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .welcome-btn {
            padding: 20px;
            border: 2px solid var(--gold);
            background: rgba(0,0,0,0.3);
            color: var(--text-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .welcome-btn:hover {
            background: rgba(212,175,55,0.2);
        }

        .welcome-btn h3 {
            color: var(--gold);
            margin-bottom: 5px;
        }

        .welcome-btn p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 0;
        }

        /* Split hands */
        .split-hands-container {
            display: flex;
            gap: 40px;
            justify-content: center;
        }

        .split-hand {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .split-hand.active {
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 10px;
            background: rgba(212,175,55,0.1);
        }

        .hand-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        /* Dealer tell visual hint */
        .card-back.tell-warm {
            animation: warmPulse 0.5s ease-out;
        }

        .card-back.tell-cool {
            animation: coolPulse 0.5s ease-out;
        }

        @keyframes warmPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 4px 25px rgba(255,180,0,0.5); }
        }

        @keyframes coolPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 4px 25px rgba(0,150,255,0.5); }
        }

        /* Game modes menu */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .menu-card {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .menu-card:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
        }

        .menu-card h4 {
            color: var(--gold);
            margin-bottom: 8px;
        }

        .menu-card p {
            font-size: 0.85rem;
            opacity: 0.7;
            margin: 0;
        }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>

    <div class="info-box">
        <div class="info-row">
            <span class="info-label">Current Bet</span>
            <span class="info-value" id="currentBetDisplay">$100</span>
        </div>
        <div class="info-row">
            <span class="info-label">Net Profit</span>
            <span class="info-value" id="balance">$1,000</span>
        </div>
    </div>

    <div class="game-container">
        <div class="table-area">
            <div class="top-bar">
                <div class="mode-buttons">
                    <button class="mode-btn" id="tellsBtn">Dealer Tells</button>
                    <button class="mode-btn" id="countingBtn">Card Counting</button>
                </div>
                <div class="top-controls">
                    <button class="icon-btn" id="soundBtn" title="Toggle Sound (M)"><svg class="sound-icon" viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
                    <button class="icon-btn" id="settingsBtn" title="Settings">âš™</button>
                    <button class="icon-btn" id="helpBtn" title="Help (?)">?</button>
                </div>
            </div>

            <div class="dealer-area">
                <div class="area-label">Dealer</div>
                <div class="cards-container" id="dealerCards"></div>
                <div class="hand-total" id="dealerTotal" style="visibility: hidden;">0</div>
            </div>

            <div class="player-area" id="playerArea">
                <div class="area-label">Your Hand</div>
                <div class="cards-container" id="playerCards"></div>
                <div class="hand-total" id="playerTotal" style="visibility: hidden;">0</div>
            </div>

            <div class="betting-area" id="bettingArea">
                <div class="bet-controls">
                    <button class="bet-btn" id="betDown"></button>
                    <input type="text" class="bet-amount" id="betAmount" value="$100" style="width: 6ch;">
                    <button class="bet-btn" id="betUp"></button>
                </div>
                <div class="action-buttons" id="actionButtons">
                    <button class="action-btn primary" id="dealBtn">Deal</button>
                </div>
            </div>

            <div class="action-buttons" id="gameActions" style="display: none;">
                <button class="action-btn primary" id="hitBtn">Hit</button>
                <button class="action-btn primary" id="standBtn">Stand</button>
                <button class="action-btn secondary" id="doubleBtn">Double</button>
                <button class="action-btn secondary" id="splitBtn">Split</button>
            </div>

            <div class="action-buttons" id="newRoundActions" style="display: none; margin-top: 20px;">
                <button class="action-btn primary" id="newRoundBtn">New Round</button>
            </div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <h2>Statistics</h2>
            <div class="stat-item">
                <span class="stat-label">Wins</span>
                <span class="stat-value" id="statWins">0</span>
            </div>
            <div class="stat-item" style="padding-left: 12px;">
                <span class="stat-label sub-stat">Blackjacks</span>
                <span class="stat-value" id="statBlackjacks">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Losses</span>
                <span class="stat-value" id="statLosses">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Pushes</span>
                <span class="stat-value" id="statPushes">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Win Rate</span>
                <span class="stat-value" id="statWinRate">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Net Profit/Loss</span>
                <span class="stat-value" id="statNetProfit">$0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Biggest Win</span>
                <span class="stat-value positive" id="statBiggestWin">$0</span>
            </div>
            <div class="streak-display" id="streakDisplay">
                <span id="streakText">No streak</span>
            </div>

            <button class="reset-stats-btn" id="resetStatsBtn">Reset Statistics</button>

            <div class="shortcuts-section">
                <h3>Keyboard Shortcuts</h3>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Hit</span>
                    <span class="shortcut-key">H</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Stand</span>
                    <span class="shortcut-key">S</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Double Down</span>
                    <span class="shortcut-key">D</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Split</span>
                    <span class="shortcut-key">P</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Deal / New Round</span>
                    <span class="shortcut-key">Enter</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Increase Bet</span>
                    <span class="shortcut-key">+</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Decrease Bet</span>
                    <span class="shortcut-key">-</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Toggle Sound</span>
                    <span class="shortcut-key">M</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Help</span>
                    <span class="shortcut-key">?</span>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-desc">Close Panels</span>
                    <span class="shortcut-key">Esc</span>
                </div>
            </div>
        </div>
    </div>

    <button class="icon-btn stats-toggle" id="statsToggle">ðŸ“Š</button>

    <!-- Result Banner -->
    <div class="result-banner" id="resultBanner">
        <div id="resultText"></div>
        <div class="payout-info" id="payoutInfo"></div>
    </div>

    <!-- Welcome Modal -->
    <div class="overlay" id="welcomeOverlay">
        <div class="modal welcome-modal">
            <h2>Blackjack</h2>
            <p class="welcome-subtitle">Beat the dealer to 21!</p>
            <div class="welcome-options">
                <button class="welcome-btn" id="startTutorialBtn">
                    <h3>ðŸŽ“ New to Blackjack?</h3>
                    <p>Learn the rules with our interactive tutorial</p>
                </button>
                <button class="welcome-btn" id="skipTutorialBtn">
                    <h3>ðŸŽ° Start Playing</h3>
                    <p>Jump straight into the game</p>
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="overlay" id="helpOverlay">
        <div class="modal">
            <button class="modal-close" id="helpClose">X</button>
            <h2>How to Play</h2>

            <div class="modal-section">
                <h3>The Goal</h3>
                <p>Get a hand total closer to 21 than the dealer's without going over. Going over 21 is a "bust" and you lose immediately.</p>
            </div>

            <div class="modal-section">
                <h3>Card Values</h3>
                <ul>
                    <li><strong>Number cards (2-10):</strong> Face value</li>
                    <li><strong>Face cards (J, Q, K):</strong> 10</li>
                    <li><strong>Ace:</strong> 11 or 1 (whichever keeps you â‰¤21)</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>Your Actions</h3>
                <ul>
                    <li><strong>Hit</strong> â€” Draw another card</li>
                    <li><strong>Stand</strong> â€” Keep your hand</li>
                    <li><strong>Double Down</strong> â€” Double bet, get one card</li>
                    <li><strong>Split</strong> â€” Split equal cards into two hands</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>Dealer Rules</h3>
                <p>Dealer must hit on 16 or below, stand on 17 or above.</p>
            </div>

            <div class="modal-section">
                <h3>Payouts</h3>
                <ul>
                    <li><strong>Win:</strong> +1.5Ã— your bet</li>
                    <li><strong>Push (tie):</strong> Bet returned</li>
                    <li><strong>Lose/Bust:</strong> Bet lost</li>
                </ul>
            </div>

            <div class="strategy-box" id="strategyBox">
                <h4>Help Me Win</h4>
                <p id="strategyText">Place a bet and deal to get strategy suggestions!</p>
                <small style="opacity: 0.7; display: block; margin-top: 10px;">Based on Basic Strategy. Individual results may vary.</small>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="modal-btn secondary" id="fullTutorialBtn">Full Tutorial</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="overlay" id="settingsOverlay">
        <div class="modal">
            <button class="modal-close" id="settingsClose">X</button>
            <h2>Settings</h2>

            <div class="settings-section">
                <h3>Theme</h3>
                <div class="theme-options">
                    <button class="theme-btn active" data-theme="classic">Classic</button>
                    <button class="theme-btn" data-theme="dark">Dark</button>
                    <button class="theme-btn" data-theme="retro">Retro</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Accessibility</h3>
                <div class="toggle-setting">
                    <span>Reduce Animations</span>
                    <div class="toggle-switch" id="reduceAnimationsToggle"></div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Sound</h3>
                <div class="toggle-setting">
                    <span>Sound Effects</span>
                    <div class="toggle-switch active" id="soundToggle"></div>
                </div>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
            </div>

            <div class="settings-section" id="newGameSection" style="display: none;">
                <h3>Reset</h3>
                <p style="margin-bottom: 15px; opacity: 0.8;">Start fresh with $1,000</p>
                <button class="modal-btn primary" id="newGameBtn">Start New Game</button>
            </div>

        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div class="overlay tutorial-overlay" id="tutorialOverlay">
        <button class="tutorial-skip" id="tutorialSkip">Skip Tutorial</button>
        <div class="modal tutorial-content">
            <div class="tutorial-progress" id="tutorialProgress"></div>
            <h2 id="tutorialTitle">Welcome to Blackjack!</h2>
            <div id="tutorialContent"></div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="modal-btn primary" id="tutorialNext">Got it â†’ Next</button>
            </div>
        </div>
    </div>

    <!-- Debt Pause Overlay -->
    <div class="overlay debt-overlay" id="debtOverlay">
        <div class="modal debt-modal">
            <h2 id="debtTitle">Reflection Time</h2>
            <div class="debt-timer" id="debtTimer">1:00</div>
            <div class="debt-question hidden" id="debtQuestion">
                <h3>Would you like to continue?</h3>
            </div>
            <div class="debt-buttons hidden" id="debtButtons">
                <button class="modal-btn primary" id="debtYes">Yes, Continue</button>
                <button class="modal-btn secondary" id="debtNo">No, Stop</button>
            </div>
        </div>
    </div>

    <!-- Card Counting HUD -->
    <div class="counter-hud" id="counterHud">
        <h3>Card Counter</h3>
        <div class="disclaimer">Educational Display â€” Not Active in Real Game</div>
        <div class="count-display">
            <span>Running Count</span>
            <span class="count-value" id="runningCount">0</span>
        </div>
        <div class="count-display">
            <span>Cards Remaining</span>
            <span class="count-value" id="cardsRemaining">52</span>
        </div>
        <div class="count-display">
            <span>True Count</span>
            <span class="count-value" id="trueCount">0.0</span>
        </div>
        <div class="count-display">
            <span>Interpretation</span>
            <span class="count-value" id="countInterpretation">Neutral</span>
        </div>
        <div class="card-history" id="cardHistory"></div>
    </div>

    <!-- Confirm Reset Modal -->
    <div class="overlay" id="confirmOverlay">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <h2 id="confirmTitle">Confirm</h2>
            <p id="confirmMessage">Are you sure?</p>
            <div style="margin-top: 25px;">
                <button class="modal-btn secondary" id="confirmCancel">Cancel</button>
                <button class="modal-btn primary" id="confirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        let gameState = {
            balance: 1000,
            currentBet: 100,
            playerHands: [[]],
            activeHandIndex: 0,
            dealerHand: [],
            deck: [],
            phase: 'betting', // betting, playing, dealerTurn, roundEnd
            splitActive: false,
            soundEnabled: true,
            volume: 0.7,
            reduceAnimations: false,
            dealerTellsMode: false,
            theme: 'classic',
            tutorialComplete: false,
            tutorialStep: 0,
            lastDebtThreshold: 0
        };

        let stats = {
            wins: 0,
            losses: 0,
            pushes: 0,
            blackjacks: 0,
            netProfit: 0,
            biggestWin: 0,
            currentStreak: 0,
            streakType: null
        };

        // ==================== INITIALIZATION ====================
        function init() {
            loadGameState();
            loadStats();
            updateBalanceDisplay();
            updateStatsDisplay();
            setupEventListeners();
            checkFirstLaunch();
        }

        function loadGameState() {
            const saved = localStorage.getItem('blackjack_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameState.balance = parsed.balance ?? 1000;
                gameState.soundEnabled = parsed.soundEnabled ?? true;
                gameState.volume = parsed.volume ?? 0.7;
                gameState.reduceAnimations = parsed.reduceAnimations ?? false;
                gameState.dealerTellsMode = parsed.dealerTellsMode ?? false;
                gameState.theme = parsed.theme ?? 'classic';
                gameState.tutorialComplete = parsed.tutorialComplete ?? false;
                gameState.lastDebtThreshold = parsed.lastDebtThreshold ?? 0;
            }
            applyTheme(gameState.theme);
            updateSoundButton();
            updateToggles();
        }

        function saveGameState() {
            localStorage.setItem('blackjack_state', JSON.stringify({
                balance: gameState.balance,
                soundEnabled: gameState.soundEnabled,
                volume: gameState.volume,
                reduceAnimations: gameState.reduceAnimations,
                dealerTellsMode: gameState.dealerTellsMode,
                theme: gameState.theme,
                tutorialComplete: gameState.tutorialComplete,
                lastDebtThreshold: gameState.lastDebtThreshold
            }));
        }

        function loadStats() {
            const saved = localStorage.getItem('blackjack_stats');
            if (saved) {
                stats = JSON.parse(saved);
            }
        }

        function saveStats() {
            localStorage.setItem('blackjack_stats', JSON.stringify(stats));
        }

        function checkFirstLaunch() {
            if (!gameState.tutorialComplete) {
                document.getElementById('welcomeOverlay').classList.add('show');
            }
        }

        // ==================== DECK FUNCTIONS ====================
        function createDeck() {
            const deck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    deck.push({ suit, rank });
                }
            }
            return deck;
        }

        function shuffleDeck(deck) {
            // Fisher-Yates shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function drawCard() {
            if (gameState.deck.length === 0) {
                gameState.deck = shuffleDeck(createDeck());
            }
            return gameState.deck.pop();
        }

        // ==================== HAND CALCULATIONS ====================
        function getCardValue(card) {
            if (card.rank === 'A') return 11;
            if (['K', 'Q', 'J'].includes(card.rank)) return 10;
            return parseInt(card.rank);
        }

        function calculateHandValue(hand) {
            let value = 0;
            let aces = 0;

            for (const card of hand) {
                if (card.hidden) continue;
                value += getCardValue(card);
                if (card.rank === 'A') aces++;
            }

            while (value > 21 && aces > 0) {
                value -= 10;
                aces--;
            }

            return value;
        }

        function isSoftHand(hand) {
            let value = 0;
            let aces = 0;

            for (const card of hand) {
                value += getCardValue(card);
                if (card.rank === 'A') aces++;
            }

            // Return true if we have an ace counted as 11
            return aces > 0 && value <= 21;
        }

        function isBlackjack(hand) {
            return hand.length === 2 && calculateHandValue(hand) === 21;
        }

        function isBust(hand) {
            return calculateHandValue(hand) > 21;
        }

        function canSplit(hand) {
            if (hand.length !== 2) return false;
            const v1 = getCardValue(hand[0]);
            const v2 = getCardValue(hand[1]);
            return v1 === v2 && gameState.balance >= gameState.currentBet;
        }

        function canDoubleDown(hand) {
            return hand.length === 2 && gameState.balance >= gameState.currentBet;
        }

        // ==================== UI RENDERING ====================
        function renderCard(card, container, hidden = false, animate = true) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card' + (animate ? ' dealing' : '');

            if (hidden) {
                cardEl.classList.add('card-back');
                card.hidden = true;
            } else {
                const isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
                cardEl.classList.add(isRed ? 'red' : 'black');
                cardEl.innerHTML = `
                    <span class="suit-top"><span class="rank">${card.rank}</span><span class="pip">${card.suit}</span></span>
                    <span class="center-suit">${card.suit}</span>
                    <span class="suit-bottom"><span class="rank">${card.rank}</span><span class="pip">${card.suit}</span></span>
                `;
            }

            container.appendChild(cardEl);
            playSound('card');
            return cardEl;
        }

        function renderHand(hand, containerId, showAll = true) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            hand.forEach((card, i) => {
                const hidden = !showAll && i === 1;
                renderCard(card, container, hidden, false);
            });
        }

        function updateTotals() {
            const playerTotal = document.getElementById('playerTotal');
            const dealerTotal = document.getElementById('dealerTotal');

            const currentHand = gameState.playerHands[gameState.activeHandIndex];
            const playerValue = calculateHandValue(currentHand);

            playerTotal.style.visibility = 'visible';
            playerTotal.textContent = playerValue;
            playerTotal.className = 'hand-total';

            if (isBust(currentHand)) {
                playerTotal.classList.add('bust');
                playerTotal.textContent = 'BUST';
            } else if (isBlackjack(currentHand)) {
                playerTotal.classList.add('blackjack');
                playerTotal.textContent = 'BLACKJACK!';
            }

            // Dealer total
            const dealerValue = calculateHandValue(gameState.dealerHand);
            const hasHiddenCard = gameState.dealerHand.some(c => c.hidden);

            if (gameState.dealerHand.length > 0) {
                dealerTotal.style.visibility = 'visible';
                if (hasHiddenCard) {
                    dealerTotal.textContent = getCardValue(gameState.dealerHand[0]);
                } else {
                    dealerTotal.textContent = dealerValue;
                    if (isBust(gameState.dealerHand)) {
                        dealerTotal.classList.add('bust');
                        dealerTotal.textContent = 'BUST';
                    }
                }
            }
        }

        function updateBalanceDisplay() {
            const balanceEl = document.getElementById('balance');
            balanceEl.textContent = formatMoney(gameState.balance);
            balanceEl.classList.toggle('negative', gameState.balance < 0);
        }

        function updateBetDisplay() {
            const input = document.getElementById('betAmount');
            input.value = formatMoney(gameState.currentBet);
            input.style.width = (input.value.length + 2) + 'ch';
            document.getElementById('currentBetDisplay').textContent = formatMoney(gameState.currentBet);
        }

        function formatMoney(amount) {
            const prefix = amount < 0 ? '-$' : '$';
            return prefix + Math.abs(amount).toLocaleString();
        }

        function updateActionButtons() {
            const currentHand = gameState.playerHands[gameState.activeHandIndex];

            document.getElementById('doubleBtn').disabled = !canDoubleDown(currentHand);
            document.getElementById('splitBtn').disabled = !canSplit(currentHand) || gameState.splitActive;
        }

        function showResult(type, message, payout = null) {
            const banner = document.getElementById('resultBanner');
            const text = document.getElementById('resultText');
            const info = document.getElementById('payoutInfo');

            banner.className = 'result-banner show ' + type;
            text.textContent = message;
            info.textContent = payout ? payout : '';

            setTimeout(() => {
                banner.classList.remove('show');
            }, 2500);
        }

        // ==================== GAME ACTIONS ====================
        function deal() {
            if (gameState.phase !== 'betting') return;

            gameState.deck = shuffleDeck(createDeck());
            gameState.playerHands = [[]];
            gameState.dealerHand = [];
            gameState.activeHandIndex = 0;
            gameState.splitActive = false;
            gameState.phase = 'playing';

            // Clear UI
            document.getElementById('playerCards').innerHTML = '';
            document.getElementById('dealerCards').innerHTML = '';
            document.getElementById('playerTotal').style.visibility = 'hidden';
            document.getElementById('dealerTotal').style.visibility = 'hidden';

            // Deal cards with animation delays
            setTimeout(() => {
                gameState.playerHands[0].push(drawCard());
                renderHand(gameState.playerHands[0], 'playerCards');

                setTimeout(() => {
                    gameState.dealerHand.push(drawCard());
                    renderHand(gameState.dealerHand, 'dealerCards');

                    setTimeout(() => {
                        gameState.playerHands[0].push(drawCard());
                        renderHand(gameState.playerHands[0], 'playerCards');

                        setTimeout(() => {
                            const holeCard = drawCard();
                            gameState.dealerHand.push(holeCard);
                            renderHand(gameState.dealerHand, 'dealerCards', false);

                            // Apply dealer tell if enabled
                            if (gameState.dealerTellsMode) {
                                applyDealerTell(holeCard);
                            }

                            updateTotals();

                            // Check for blackjacks
                            if (isBlackjack(gameState.playerHands[0])) {
                                setTimeout(() => revealAndResolve(), 500);
                            } else {
                                showGameActions();
                                updateActionButtons();
                                updateStrategyHint();
                            }
                        }, 300);
                    }, 300);
                }, 300);
            }, 100);

            // Update UI
            document.getElementById('bettingArea').style.display = 'none';
        }

        function hit() {
            if (gameState.phase !== 'playing') return;

            const currentHand = gameState.playerHands[gameState.activeHandIndex];
            currentHand.push(drawCard());
            renderHand(currentHand, 'playerCards');
            updateTotals();
            updateStrategyHint();

            // Disable double and split after first hit
            document.getElementById('doubleBtn').disabled = true;
            document.getElementById('splitBtn').disabled = true;

            if (isBust(currentHand)) {
                playSound('lose');
                if (gameState.splitActive && gameState.activeHandIndex < gameState.playerHands.length - 1) {
                    setTimeout(() => nextSplitHand(), 1000);
                } else {
                    setTimeout(() => resolveRound(), 1000);
                }
            }
        }

        function stand() {
            if (gameState.phase !== 'playing') return;

            if (gameState.splitActive && gameState.activeHandIndex < gameState.playerHands.length - 1) {
                nextSplitHand();
            } else {
                revealAndResolve();
            }
        }

        function doubleDown() {
            if (gameState.phase !== 'playing') return;
            if (!canDoubleDown(gameState.playerHands[gameState.activeHandIndex])) return;

            gameState.currentBet *= 2;
            updateBetDisplay();

            const currentHand = gameState.playerHands[gameState.activeHandIndex];
            currentHand.push(drawCard());
            renderHand(currentHand, 'playerCards');
            updateTotals();

            if (isBust(currentHand)) {
                playSound('lose');
                setTimeout(() => resolveRound(), 1000);
            } else {
                revealAndResolve();
            }
        }

        function split() {
            if (gameState.phase !== 'playing') return;
            if (!canSplit(gameState.playerHands[0])) return;

            const originalHand = gameState.playerHands[0];
            gameState.playerHands = [
                [originalHand[0], drawCard()],
                [originalHand[1], drawCard()]
            ];
            gameState.splitActive = true;
            gameState.activeHandIndex = 0;

            // Render first hand
            renderHand(gameState.playerHands[0], 'playerCards');
            updateTotals();
            updateActionButtons();

            // Check for split aces (only one card each)
            if (originalHand[0].rank === 'A') {
                if (gameState.activeHandIndex < gameState.playerHands.length - 1) {
                    setTimeout(() => nextSplitHand(), 1000);
                } else {
                    revealAndResolve();
                }
            }
        }

        function nextSplitHand() {
            gameState.activeHandIndex++;
            renderHand(gameState.playerHands[gameState.activeHandIndex], 'playerCards');
            updateTotals();
            updateActionButtons();

            // Check for split aces
            if (gameState.playerHands[gameState.activeHandIndex][0].rank === 'A') {
                revealAndResolve();
            }
        }

        function revealAndResolve() {
            gameState.phase = 'dealerTurn';
            hideGameActions();

            // Reveal hole card
            gameState.dealerHand.forEach(c => c.hidden = false);
            renderHand(gameState.dealerHand, 'dealerCards');

            const dealerCards = document.getElementById('dealerCards');
            if (dealerCards.children[1]) {
                dealerCards.children[1].classList.add('flip');
            }
            playSound('flip');

            // Dealer plays
            dealerPlay();
        }

        function dealerPlay() {
            setTimeout(() => {
                updateTotals();
                const dealerValue = calculateHandValue(gameState.dealerHand);

                if (dealerValue < 17) {
                    gameState.dealerHand.push(drawCard());
                    renderHand(gameState.dealerHand, 'dealerCards');
                    dealerPlay();
                } else {
                    resolveRound();
                }
            }, 700);
        }

        function resolveRound() {
            gameState.phase = 'roundEnd';
            updateTotals();

            const dealerValue = calculateHandValue(gameState.dealerHand);
            const dealerBust = isBust(gameState.dealerHand);
            const dealerBJ = isBlackjack(gameState.dealerHand);

            let totalWinnings = 0;
            let results = [];

            gameState.playerHands.forEach((hand, idx) => {
                const playerValue = calculateHandValue(hand);
                const playerBust = isBust(hand);
                const playerBJ = isBlackjack(hand);

                let result;
                let payout = 0;

                if (playerBust) {
                    result = 'lose';
                    payout = -gameState.currentBet / (gameState.splitActive ? 2 : 1);
                } else if (playerBJ && dealerBJ) {
                    result = 'push';
                } else if (playerBJ) {
                    result = 'blackjack';
                    payout = gameState.currentBet * 1.5 / (gameState.splitActive ? 2 : 1);
                    stats.blackjacks++;
                } else if (dealerBust) {
                    result = 'win';
                    payout = gameState.currentBet * 1.5 / (gameState.splitActive ? 2 : 1);
                } else if (playerValue > dealerValue) {
                    result = 'win';
                    payout = gameState.currentBet * 1.5 / (gameState.splitActive ? 2 : 1);
                } else if (playerValue < dealerValue) {
                    result = 'lose';
                    payout = -gameState.currentBet / (gameState.splitActive ? 2 : 1);
                } else {
                    result = 'push';
                }

                totalWinnings += payout;
                results.push({ result, payout });
            });

            // Apply winnings
            gameState.balance += totalWinnings;
            stats.netProfit += totalWinnings;

            // Update stats
            const mainResult = results[0].result;
            if (mainResult === 'win' || mainResult === 'blackjack') {
                stats.wins++;
                if (stats.streakType === 'win') {
                    stats.currentStreak++;
                } else {
                    stats.streakType = 'win';
                    stats.currentStreak = 1;
                }
                if (totalWinnings > stats.biggestWin) {
                    stats.biggestWin = totalWinnings;
                }
            } else if (mainResult === 'lose') {
                stats.losses++;
                if (stats.streakType === 'lose') {
                    stats.currentStreak++;
                } else {
                    stats.streakType = 'lose';
                    stats.currentStreak = 1;
                }
            } else {
                stats.pushes++;
                stats.currentStreak = 0;
                stats.streakType = null;
            }

            // Show result
            let message, type, payoutText;
            if (mainResult === 'blackjack') {
                message = 'BLACKJACK!';
                type = 'blackjack';
                payoutText = '+' + formatMoney(totalWinnings);
                triggerFireworks(true);
            } else if (mainResult === 'win') {
                message = 'YOU WIN!';
                type = 'win';
                payoutText = '+' + formatMoney(totalWinnings);
                triggerFireworks(false);
            } else if (mainResult === 'lose') {
                message = 'DEALER WINS';
                type = 'lose';
                payoutText = formatMoney(totalWinnings);
            } else {
                message = 'PUSH';
                type = 'push';
                payoutText = 'Bet returned';
            }

            playSound(mainResult === 'win' || mainResult === 'blackjack' ? 'win' : mainResult === 'lose' ? 'lose' : 'push');
            showResult(type, message, payoutText);

            // Save and update UI
            updateBalanceDisplay();
            updateStatsDisplay();
            saveGameState();
            saveStats();

            // Check debt threshold
            checkDebtThreshold();

            // Show new round button
            document.getElementById('newRoundActions').style.display = 'flex';
        }

        function newRound() {
            gameState.phase = 'betting';

            document.getElementById('bettingArea').style.display = 'flex';
            document.getElementById('newRoundActions').style.display = 'none';
            document.getElementById('playerCards').innerHTML = '';
            document.getElementById('dealerCards').innerHTML = '';
            document.getElementById('playerTotal').style.visibility = 'hidden';
            document.getElementById('dealerTotal').style.visibility = 'hidden';
            document.getElementById('playerTotal').className = 'hand-total';
            document.getElementById('dealerTotal').className = 'hand-total';

            updateBetDisplay();
        }

        function showGameActions() {
            document.getElementById('gameActions').style.display = 'flex';
        }

        function hideGameActions() {
            document.getElementById('gameActions').style.display = 'none';
        }

        // ==================== BETTING ====================
        function adjustBet(delta) {
            const newBet = gameState.currentBet + delta;
            if (newBet >= 10 && newBet <= 500) {
                gameState.currentBet = newBet;
                updateBetDisplay();
            }
        }

        // ==================== STATS ====================
        function updateStatsDisplay() {
            document.getElementById('statWins').textContent = stats.wins;
            document.getElementById('statBlackjacks').textContent = stats.blackjacks;
            document.getElementById('statLosses').textContent = stats.losses;
            document.getElementById('statPushes').textContent = stats.pushes;

            const total = stats.wins + stats.losses + stats.pushes;
            const winRate = total > 0 ? Math.round((stats.wins / total) * 100) : 0;
            document.getElementById('statWinRate').textContent = winRate + '%';

            const profitEl = document.getElementById('statNetProfit');
            profitEl.textContent = formatMoney(stats.netProfit);
            profitEl.className = 'stat-value ' + (stats.netProfit >= 0 ? 'positive' : 'negative');

            document.getElementById('statBiggestWin').textContent = formatMoney(stats.biggestWin);

            const streakEl = document.getElementById('streakDisplay');
            const streakText = document.getElementById('streakText');

            if (stats.currentStreak > 0 && stats.streakType) {
                streakText.textContent = `${stats.currentStreak} ${stats.streakType === 'win' ? 'Win' : 'Loss'} Streak`;
                streakEl.className = 'streak-display ' + stats.streakType + '-streak';
            } else {
                streakText.textContent = 'No streak';
                streakEl.className = 'streak-display';
            }
        }

        function resetStats() {
            stats = {
                wins: 0,
                losses: 0,
                pushes: 0,
                blackjacks: 0,
                netProfit: 0,
                biggestWin: 0,
                currentStreak: 0,
                streakType: null
            };
            saveStats();
            updateStatsDisplay();
        }

        // ==================== FIREWORKS ====================
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let fireworksActive = false;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor(x, y, color, size = 3) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = size;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 6 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.alpha = 1;
                this.decay = Math.random() * 0.02 + 0.015;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1; // gravity
                this.alpha -= this.decay;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function createBurst(x, y, count = 100) {
            const colors = ['#FFD700', '#FFFFFF', '#4CAF50', '#FFC107', '#E91E63'];
            for (let i = 0; i < count; i++) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                particles.push(new Particle(x, y, color, Math.random() * 3 + 1));
            }
        }

        function triggerFireworks(isBlackjack = false) {
            if (gameState.reduceAnimations) return;

            fireworksActive = true;
            const burstCount = isBlackjack ? 7 : 4;
            const particleCount = isBlackjack ? 120 : 80;

            for (let i = 0; i < burstCount; i++) {
                setTimeout(() => {
                    const x = Math.random() * canvas.width * 0.6 + canvas.width * 0.2;
                    const y = Math.random() * canvas.height * 0.4 + canvas.height * 0.2;
                    createBurst(x, y, particleCount);
                    playSound('win');
                }, i * (isBlackjack ? 100 : 200));
            }

            setTimeout(() => {
                fireworksActive = false;
            }, isBlackjack ? 3000 : 2000);
        }

        function animateFireworks() {
            if (particles.length > 0 || fireworksActive) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                particles = particles.filter(p => p.alpha > 0);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
            }
            requestAnimationFrame(animateFireworks);
        }

        animateFireworks();

        // ==================== SOUND ====================
        function playSound(type) {
            if (!gameState.soundEnabled) return;

            // Create oscillator-based sounds
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.value = gameState.volume * 0.3;

            switch(type) {
                case 'card':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'win':
                    oscillator.frequency.value = 523;
                    oscillator.type = 'sine';
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start();
                    setTimeout(() => {
                        oscillator.frequency.value = 659;
                    }, 100);
                    setTimeout(() => {
                        oscillator.frequency.value = 784;
                    }, 200);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'lose':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'push':
                    oscillator.frequency.value = 440;
                    oscillator.type = 'sine';
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
                case 'flip':
                    oscillator.frequency.value = 600;
                    oscillator.type = 'triangle';
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.15);
                    break;
            }
        }

        function updateSoundButton() {
            const btn = document.getElementById('soundBtn');
            btn.innerHTML = gameState.soundEnabled
                ? '<svg class="sound-icon" viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>'
                : '<svg class="sound-icon" viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            updateSoundButton();
            saveGameState();
        }

        // ==================== DEALER TELLS ====================
        function applyDealerTell(holeCard) {
            const value = getCardValue(holeCard);
            const cardBack = document.querySelector('#dealerCards .card-back');
            if (!cardBack) return;

            // Only apply tell 65-70% of the time
            if (Math.random() > 0.68) return;

            if (value <= 6) {
                // Weak card - warm tint
                cardBack.classList.add('tell-warm');
            } else if (value >= 10) {
                // Strong card - cool tint
                cardBack.classList.add('tell-cool');
            }
        }

        // ==================== STRATEGY HINTS ====================
        function updateStrategyHint() {
            const box = document.getElementById('strategyBox');
            const text = document.getElementById('strategyText');

            if (gameState.phase !== 'playing') {
                text.textContent = 'Place a bet and deal to get strategy suggestions!';
                box.classList.add('disabled');
                return;
            }

            box.classList.remove('disabled');

            const hand = gameState.playerHands[gameState.activeHandIndex];
            const playerTotal = calculateHandValue(hand);
            const dealerUpcard = getCardValue(gameState.dealerHand[0]);
            const soft = isSoftHand(hand);
            const canSplitHand = canSplit(hand);
            const canDouble = canDoubleDown(hand);

            let suggestion = '';
            let explanation = '';

            // Check for pairs first
            if (canSplitHand && hand.length === 2) {
                const pairValue = getCardValue(hand[0]);

                if (pairValue === 11) { // Aces
                    suggestion = 'Split';
                    explanation = 'Always split Aces. Two chances at 21 is far better than a soft 12.';
                } else if (pairValue === 8) {
                    suggestion = 'Split';
                    explanation = 'Always split 8s. 16 is the worst hand; two 8s give you better chances.';
                } else if (pairValue === 10) {
                    suggestion = 'Stand';
                    explanation = 'Never split 10s. 20 is already a strong hand.';
                } else if (pairValue === 9 && (dealerUpcard <= 6 || dealerUpcard === 8 || dealerUpcard === 9)) {
                    suggestion = 'Split';
                    explanation = 'Split 9s against dealer 2-6, 8-9. Otherwise stand on your 18.';
                } else if (pairValue === 7 && dealerUpcard <= 7) {
                    suggestion = 'Split';
                    explanation = 'Split 7s against dealer 2-7.';
                } else if (pairValue === 6 && dealerUpcard <= 6) {
                    suggestion = 'Split';
                    explanation = 'Split 6s against dealer 2-6.';
                } else if (pairValue === 5 && dealerUpcard <= 9 && canDouble) {
                    suggestion = 'Double Down';
                    explanation = 'Never split 5s. Double down on your 10 against dealer 2-9.';
                } else if (pairValue === 4 && (dealerUpcard === 5 || dealerUpcard === 6)) {
                    suggestion = 'Split';
                    explanation = 'Split 4s only against dealer 5-6.';
                } else if ((pairValue === 2 || pairValue === 3) && dealerUpcard <= 7) {
                    suggestion = 'Split';
                    explanation = 'Split 2s/3s against dealer 2-7.';
                }
            }

            // If no split suggestion, check soft hands
            if (!suggestion && soft) {
                if (playerTotal >= 19) {
                    suggestion = 'Stand';
                    explanation = 'Soft 19+ is strong. Stand and let the dealer play.';
                } else if (playerTotal === 18) {
                    if (dealerUpcard >= 9) {
                        suggestion = 'Hit';
                        explanation = 'Soft 18 vs dealer 9+ - hit to improve. You can\'t bust with a soft hand.';
                    } else {
                        suggestion = 'Stand';
                        explanation = 'Soft 18 is solid against dealer 2-8.';
                    }
                } else if (playerTotal === 17 && dealerUpcard >= 3 && dealerUpcard <= 6 && canDouble) {
                    suggestion = 'Double Down';
                    explanation = 'Double on soft 17 vs dealer 3-6. Dealer is likely to bust.';
                } else {
                    suggestion = 'Hit';
                    explanation = 'Hit your soft hand. You can\'t bust and might improve.';
                }
            }

            // Hard hands
            if (!suggestion) {
                if (playerTotal >= 17) {
                    suggestion = 'Stand';
                    explanation = 'Stand on 17+. Risk of busting is too high.';
                } else if (playerTotal >= 13 && playerTotal <= 16 && dealerUpcard <= 6) {
                    suggestion = 'Stand';
                    explanation = `Your ${playerTotal} is weak, but dealer shows ${dealerUpcard} and is likely to bust.`;
                } else if (playerTotal === 12 && dealerUpcard >= 4 && dealerUpcard <= 6) {
                    suggestion = 'Stand';
                    explanation = 'Stand on 12 vs dealer 4-6. Let the dealer bust.';
                } else if (playerTotal === 11 && canDouble) {
                    suggestion = 'Double Down';
                    explanation = '11 is the best double down hand. You\'re likely to hit 21!';
                } else if (playerTotal === 10 && dealerUpcard <= 9 && canDouble) {
                    suggestion = 'Double Down';
                    explanation = 'Double on 10 vs dealer 2-9. Great position to capitalize.';
                } else if (playerTotal === 9 && dealerUpcard >= 3 && dealerUpcard <= 6 && canDouble) {
                    suggestion = 'Double Down';
                    explanation = 'Double on 9 vs dealer 3-6. Dealer is in a tough spot.';
                } else {
                    suggestion = 'Hit';
                    explanation = `Your ${playerTotal} needs improvement against dealer ${dealerUpcard}.`;
                }
            }

            text.innerHTML = `<strong>${suggestion}</strong> â€” ${explanation}`;
        }

        // ==================== TUTORIAL ====================
        const tutorialLessons = [
            {
                title: 'Lesson 1: The Goal',
                content: `
                    <p>Welcome to Blackjack! The goal is simple:</p>
                    <div style="font-size: 1.3rem; text-align: center; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; margin: 20px 0;">
                        <strong>Get closer to 21 than the dealer without going over.</strong>
                    </div>
                    <p>If your hand exceeds 21, you <strong>"bust"</strong> and lose immediately â€” even if the dealer also busts later!</p>
                `
            },
            {
                title: 'Lesson 2: Card Values',
                content: `
                    <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">2-10</div>
                            <div>Face value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">J Q K</div>
                            <div>Worth 10</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">A</div>
                            <div>11 or 1</div>
                        </div>
                    </div>
                    <p>Aces are flexible! They count as 11 unless that would bust your hand, then they count as 1.</p>
                    <div class="quiz-options" id="quizOptions">
                        <p><strong>Quick Quiz:</strong> What's the total of Kâ™  and 7â™¥?</p>
                        <div class="quiz-option" data-answer="wrong">14</div>
                        <div class="quiz-option" data-answer="correct">17</div>
                        <div class="quiz-option" data-answer="wrong">21</div>
                    </div>
                `
            },
            {
                title: 'Lesson 3: The Deal',
                content: `
                    <p>Each round starts with 4 cards dealt:</p>
                    <ul style="margin: 15px 0 15px 20px;">
                        <li><strong>You</strong> get 2 cards, both face-up</li>
                        <li><strong>Dealer</strong> gets 2 cards, but one stays hidden (the "hole card")</li>
                    </ul>
                    <div style="display: flex; justify-content: space-around; margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <div style="text-align: center;">
                            <div>Your Hand</div>
                            <div style="font-size: 1.5rem;">Kâ™  7â™¥</div>
                            <div>Total: 17</div>
                        </div>
                        <div style="text-align: center;">
                            <div>Dealer</div>
                            <div style="font-size: 1.5rem;">9â™£ ?</div>
                            <div>Showing: 9</div>
                        </div>
                    </div>
                    <p>You can see what the dealer is showing, which helps you decide your next move!</p>
                `
            },
            {
                title: 'Lesson 4: Your Actions',
                content: `
                    <div style="display: grid; gap: 15px; margin: 20px 0;">
                        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid var(--gold);">
                            <strong>Hit</strong><br>
                            <small>Draw another card. Be careful not to bust!</small>
                        </div>
                        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid var(--gold);">
                            <strong>Stand</strong><br>
                            <small>Keep your current hand. The dealer plays next.</small>
                        </div>
                        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid rgba(255,255,255,0.3);">
                            <strong>Double Down</strong><br>
                            <small>Double your bet, get exactly one more card. Bold move!</small>
                        </div>
                        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid rgba(255,255,255,0.3);">
                            <strong>Split</strong><br>
                            <small>If you have a pair, split into two separate hands.</small>
                        </div>
                    </div>
                `
            },
            {
                title: 'Lesson 5: The Dealer\'s Turn',
                content: `
                    <p>After you stand, the dealer reveals their hidden card and must follow strict rules:</p>
                    <div style="padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; margin: 20px 0; text-align: center;">
                        <p style="font-size: 1.2rem;"><strong>Dealer must hit on 16 or below</strong></p>
                        <p style="font-size: 1.2rem;"><strong>Dealer must stand on 17 or above</strong></p>
                    </div>
                    <p>The dealer has no choice â€” they must follow these rules. This is your advantage: you can choose to stand on a risky hand when you think the dealer will bust!</p>
                `
            },
            {
                title: 'Lesson 6: Payouts',
                content: `
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(76,175,80,0.3); border-radius: 8px; margin-bottom: 10px;">
                            <span>Win</span>
                            <strong>+1.5Ã— your bet</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(76,175,80,0.3); border-radius: 8px; margin-bottom: 10px;">
                            <span>Blackjack (A + 10)</span>
                            <strong>+1.5Ã— your bet</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,193,7,0.3); border-radius: 8px; margin-bottom: 10px;">
                            <span>Push (tie)</span>
                            <strong>Bet returned</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(244,67,54,0.3); border-radius: 8px;">
                            <span>Lose / Bust</span>
                            <strong>Bet lost</strong>
                        </div>
                    </div>
                    <p style="text-align: center; font-size: 1.2rem; margin-top: 20px;">
                        <strong>You're ready to play! ðŸŽ°</strong>
                    </p>
                `
            }
        ];

        function startTutorial() {
            gameState.tutorialStep = 0;
            document.getElementById('welcomeOverlay').classList.remove('show');
            document.getElementById('tutorialOverlay').classList.add('show');
            renderTutorialStep();
        }

        function renderTutorialStep() {
            const lesson = tutorialLessons[gameState.tutorialStep];
            const progress = document.getElementById('tutorialProgress');
            const title = document.getElementById('tutorialTitle');
            const content = document.getElementById('tutorialContent');
            const nextBtn = document.getElementById('tutorialNext');

            // Render progress dots
            progress.innerHTML = tutorialLessons.map((_, i) => {
                let cls = 'tutorial-dot';
                if (i < gameState.tutorialStep) cls += ' complete';
                if (i === gameState.tutorialStep) cls += ' active';
                return `<div class="${cls}"></div>`;
            }).join('');

            title.textContent = lesson.title;
            content.innerHTML = lesson.content;

            // Update button text
            if (gameState.tutorialStep === tutorialLessons.length - 1) {
                nextBtn.textContent = 'Start Playing!';
            } else {
                nextBtn.textContent = 'Got it â†’ Next';
            }

            // Add quiz handlers if present
            const quizOptions = document.querySelectorAll('.quiz-option');
            quizOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                    quizOptions.forEach(o => o.classList.remove('correct', 'incorrect'));
                    if (opt.dataset.answer === 'correct') {
                        opt.classList.add('correct');
                    } else {
                        opt.classList.add('incorrect');
                        document.querySelector('[data-answer="correct"]').classList.add('correct');
                    }
                });
            });
        }

        function nextTutorialStep() {
            gameState.tutorialStep++;
            if (gameState.tutorialStep >= tutorialLessons.length) {
                completeTutorial();
            } else {
                renderTutorialStep();
            }
        }

        function skipTutorial() {
            gameState.tutorialComplete = true;
            saveGameState();
            document.getElementById('welcomeOverlay').classList.remove('show');
            document.getElementById('tutorialOverlay').classList.remove('show');
        }

        function completeTutorial() {
            gameState.tutorialComplete = true;
            saveGameState();
            document.getElementById('tutorialOverlay').classList.remove('show');
        }

        // ==================== DEBT PAUSE ====================
        function checkDebtThreshold() {
            const debt = Math.abs(Math.min(0, gameState.balance));
            const threshold = Math.floor(debt / 10000) * 10000;

            if (threshold > 0 && threshold > gameState.lastDebtThreshold) {
                gameState.lastDebtThreshold = threshold;
                showDebtPause(threshold);
            }
        }

        let debtCountdownInterval = null;

        function showDebtPause(amount) {
            const overlay = document.getElementById('debtOverlay');
            const timer = document.getElementById('debtTimer');
            const buttons = document.getElementById('debtButtons');
            const question = document.getElementById('debtQuestion');

            // Clear any existing countdown
            if (debtCountdownInterval) {
                clearInterval(debtCountdownInterval);
            }

            overlay.classList.add('show');
            buttons.classList.add('hidden');
            question.classList.add('hidden');

            const minutes = amount / 10000;
            let seconds = minutes * 60;

            // Show initial time
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            timer.textContent = `${m}:${s.toString().padStart(2, '0')}`;

            debtCountdownInterval = setInterval(() => {
                seconds--;
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                timer.textContent = `${m}:${s.toString().padStart(2, '0')}`;

                if (seconds <= 0) {
                    clearInterval(debtCountdownInterval);
                    debtCountdownInterval = null;
                    timer.textContent = '';
                    question.classList.remove('hidden');
                    buttons.classList.remove('hidden');
                }
            }, 1000);

            playSound('lose');
        }

        function closeDebtPause(continueGame) {
            document.getElementById('debtOverlay').classList.remove('show');
            if (!continueGame) {
                window.close();
                // Fallback if window.close doesn't work
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:2rem;">Thanks for playing. You can close this tab.</div>';
            }
        }

        // ==================== RELOAD CHIPS ====================
        function showReloadPrompt() {
            showConfirm('Out of Chips!', 'Would you like to reload with $1,000?', () => {
                gameState.balance = 1000;
                gameState.lastDebtThreshold = 0;
                updateBalanceDisplay();
                saveGameState();
            });
        }

        function reloadChips() {
            showConfirm('Reload Chips', 'Reset your balance to $1,000?', () => {
                gameState.balance = 1000;
                gameState.lastDebtThreshold = 0;
                updateBalanceDisplay();
                saveGameState();
                document.getElementById('settingsOverlay').classList.remove('show');
            });
        }

        // ==================== CONFIRM DIALOG ====================
        function showConfirm(title, message, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmOverlay').classList.add('show');

            document.getElementById('confirmOk').onclick = () => {
                document.getElementById('confirmOverlay').classList.remove('show');
                onConfirm();
            };

            document.getElementById('confirmCancel').onclick = () => {
                document.getElementById('confirmOverlay').classList.remove('show');
            };
        }

        // ==================== THEME ====================
        function applyTheme(theme) {
            document.body.className = '';
            if (theme === 'dark') {
                document.body.classList.add('theme-dark');
            } else if (theme === 'retro') {
                document.body.classList.add('theme-retro');
            }
            gameState.theme = theme;

            // Update theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
        }

        function updateToggles() {
            document.getElementById('soundToggle').classList.toggle('active', gameState.soundEnabled);
            document.getElementById('reduceAnimationsToggle').classList.toggle('active', gameState.reduceAnimations);
            document.getElementById('tellsBtn').classList.toggle('active', gameState.dealerTellsMode);
            document.getElementById('volumeSlider').value = gameState.volume * 100;
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Betting
            document.getElementById('betUp').addEventListener('click', () => adjustBet(10));
            document.getElementById('betDown').addEventListener('click', () => adjustBet(-10));

            document.getElementById('betAmount').addEventListener('change', (e) => {
                const value = parseInt(e.target.value.replace(/[^0-9]/g, '')) || 0;
                gameState.currentBet = Math.max(10, Math.min(value, 10000));
                updateBetDisplay();
                saveGameState();
            });

            document.getElementById('betAmount').addEventListener('focus', (e) => {
                e.target.select();
            });
            document.getElementById('dealBtn').addEventListener('click', deal);

            // Game actions
            document.getElementById('hitBtn').addEventListener('click', hit);
            document.getElementById('standBtn').addEventListener('click', stand);
            document.getElementById('doubleBtn').addEventListener('click', doubleDown);
            document.getElementById('splitBtn').addEventListener('click', split);
            document.getElementById('newRoundBtn').addEventListener('click', newRound);

            // Top bar
            document.getElementById('soundBtn').addEventListener('click', toggleSound);
            document.getElementById('helpBtn').addEventListener('click', () => {
                document.getElementById('helpOverlay').classList.add('show');
                updateStrategyHint();
            });
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.add('show');
                // Show new game option if in deep debt
                document.getElementById('newGameSection').style.display =
                    gameState.balance <= -100000 ? 'block' : 'none';
            });

            document.getElementById('newGameBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to start a new game? All progress will be lost.')) {
                    gameState.balance = 1000;
                    gameState.currentBet = 100;
                    gameState.lastDebtThreshold = 0;
                    stats.wins = 0;
                    stats.losses = 0;
                    stats.pushes = 0;
                    stats.blackjacks = 0;
                    stats.netProfit = 0;
                    stats.biggestWin = 0;
                    stats.currentStreak = 0;
                    stats.streakType = null;
                    saveGameState();
                    updateBalanceDisplay();
                    updateStatsDisplay();
                    updateBetDisplay();
                    document.getElementById('settingsOverlay').classList.remove('show');
                    newRound();
                }
            });

            // Modal closes
            document.getElementById('helpClose').addEventListener('click', () => {
                document.getElementById('helpOverlay').classList.remove('show');
            });
            document.getElementById('settingsClose').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.remove('show');
            });

            // Welcome/Tutorial
            document.getElementById('startTutorialBtn').addEventListener('click', startTutorial);
            document.getElementById('skipTutorialBtn').addEventListener('click', skipTutorial);
            document.getElementById('tutorialSkip').addEventListener('click', skipTutorial);
            document.getElementById('tutorialNext').addEventListener('click', nextTutorialStep);
            document.getElementById('fullTutorialBtn').addEventListener('click', () => {
                document.getElementById('helpOverlay').classList.remove('show');
                startTutorial();
            });

            // Stats
            document.getElementById('resetStatsBtn').addEventListener('click', () => {
                showConfirm('Reset Statistics', 'Are you sure you want to clear all statistics?', resetStats);
            });
            document.getElementById('statsToggle').addEventListener('click', () => {
                document.getElementById('statsPanel').classList.toggle('open');
            });

            // Settings toggles
            document.getElementById('soundToggle').addEventListener('click', () => {
                gameState.soundEnabled = !gameState.soundEnabled;
                updateToggles();
                updateSoundButton();
                saveGameState();
            });

            document.getElementById('reduceAnimationsToggle').addEventListener('click', () => {
                gameState.reduceAnimations = !gameState.reduceAnimations;
                updateToggles();
                saveGameState();
            });

            // Top bar mode buttons
            document.getElementById('tellsBtn').addEventListener('click', () => {
                gameState.dealerTellsMode = !gameState.dealerTellsMode;
                document.getElementById('tellsBtn').classList.toggle('active', gameState.dealerTellsMode);
                updateToggles();
                saveGameState();
            });

            document.getElementById('countingBtn').addEventListener('click', () => {
                document.getElementById('counterOverlay').classList.add('show');
            });

            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                gameState.volume = e.target.value / 100;
                saveGameState();
            });

            // Theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    applyTheme(btn.dataset.theme);
                    saveGameState();
                });
            });

            // Debt pause
            document.getElementById('debtYes').addEventListener('click', () => closeDebtPause(true));
            document.getElementById('debtNo').addEventListener('click', () => closeDebtPause(false));

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Don't trigger during input or when overlays are open
                if (e.target.tagName === 'INPUT') return;
                if (document.getElementById('debtOverlay').classList.contains('show')) return;

                const key = e.key.toLowerCase();

                if (key === 'h' && gameState.phase === 'playing') {
                    hit();
                } else if (key === 's' && gameState.phase === 'playing') {
                    stand();
                } else if (key === 'd' && gameState.phase === 'playing') {
                    doubleDown();
                } else if (key === 'p' && gameState.phase === 'playing') {
                    split();
                } else if ((key === 'enter' || key === ' ') && gameState.phase === 'betting') {
                    e.preventDefault();
                    deal();
                } else if ((key === 'enter' || key === ' ') && gameState.phase === 'roundEnd') {
                    e.preventDefault();
                    newRound();
                } else if (key === '=' || key === '+') {
                    adjustBet(10);
                } else if (key === '-') {
                    adjustBet(-10);
                } else if (key === 'm') {
                    toggleSound();
                } else if (key === '?') {
                    document.getElementById('helpOverlay').classList.toggle('show');
                    updateStrategyHint();
                } else if (key === 'escape') {
                    document.querySelectorAll('.overlay').forEach(o => {
                        if (!o.id.includes('debt') && !o.id.includes('welcome')) {
                            o.classList.remove('show');
                        }
                    });
                    document.getElementById('statsPanel').classList.remove('open');
                }
            });

            // Close overlays when clicking outside
            document.querySelectorAll('.overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay && !overlay.id.includes('debt') && !overlay.id.includes('welcome') && !overlay.id.includes('tutorial')) {
                        overlay.classList.remove('show');
                    }
                });
            });
        }

        // Start the game
        init();
    </script>
</body>
</html>
